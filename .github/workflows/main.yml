name: Full CI/CD Pipeline - Maven Spring Boot on EC2 (Safe)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout (pipeline context only)
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Clone or Pull Repo on EC2
      - name: Clone / Pull Repository on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e

            sudo yum install -y git maven java-17-amazon-corretto || true

            APP_DIR=/home/ec2-user/app
            REPO_NAME=Java-springboot-project
            REPO_URL=https://github.com/amit6264/Java-springboot-project.git

            mkdir -p $APP_DIR
            cd $APP_DIR

            if [ -d "$REPO_NAME/.git" ]; then
              echo "Repo exists â†’ pulling latest changes"
              cd $REPO_NAME
              git reset --hard
              git pull origin main
            else
              echo "Cloning repository"
              git clone $REPO_URL
              cd $REPO_NAME
            fi

      # 3ï¸âƒ£ Build Maven Application
      - name: Build Maven Application
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e
            cd /home/ec2-user/app/Java-springboot-project/backend
            mvn clean package -DskipTests -U

      # # 4ï¸âƒ£ Stop Existing Application (SAFE)
      # - name: Stop Old Application
      #   uses: appleboy/ssh-action@v1.1.0
      #   with:
      #     host: ${{ secrets.EC2_HOST }}
      #     username: ec2-user
      #     key: ${{ secrets.EC2_KEY }}
      #     script_stop: false
      #     script: |
      #       PIDS=$(pgrep -f "java.*datastore-0.0.7.jar" || true)

      #       if [ -n "$PIDS" ]; then
      #         echo "Stopping application PIDs: $PIDS"

      #         # Graceful shutdown
      #         kill $PIDS || true
      #         sleep 5

      #         # Force kill if still alive
      #         for PID in $PIDS; do
      #           if ps -p $PID > /dev/null; then
      #             echo "Force killing PID $PID"
      #             kill -9 $PID || true
      #           fi
      #         done
      #       else
      #         echo "No running application found"
      #       fi

      # 5ï¸âƒ£ Start New Application
      - name: Start Application
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e

            LOG_DIR=/var/log/app
            sudo mkdir -p $LOG_DIR
            sudo chown ec2-user:ec2-user $LOG_DIR

            cd /home/ec2-user/app/Java-springboot-project/backend/target

            nohup env \
              MYSQL_HOST=${{ secrets.DB_HOST }} \
              MYSQL_PORT=3306 \
              MYSQL_USERNAME=${{ secrets.DB_USERNAME }} \
              MYSQL_PASSWORD=${{ secrets.DB_PASSWORD }} \
              LOG_FILE_PATH=$LOG_DIR/datastore.log \
              java -jar datastore-0.0.7.jar \
              --server.port=8084 \
              > $LOG_DIR/nohup.out 2>&1 &

            echo "ðŸš€ Application started successfully"
#The End
